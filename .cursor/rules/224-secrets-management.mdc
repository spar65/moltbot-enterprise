---
description: Apply secrets management standards to ensure secure storage, rotation, and access control of sensitive credentials and API keys
globs: "**/*"
---

# Secrets Management Standards

## Context
Hardcoded secrets are the #1 security vulnerability. Leaked credentials cause data breaches, unauthorized access, and financial loss. This rule establishes comprehensive standards for managing secrets safely throughout their lifecycle.

**Critical Principles:**
- Never commit secrets to git (EVER!)
- Rotate secrets regularly (30-90 days)
- Use different secrets per environment
- Audit secret access
- Revoke secrets immediately when compromised

## Requirements

### 1. What is a Secret?

**Secrets Include:**
```yaml
API Keys:
  - Third-party service keys (Stripe, OpenAI, etc.)
  - Internal API keys
  - Service-to-service authentication tokens

Credentials:
  - Database passwords
  - Admin passwords
  - Service account credentials

Certificates & Keys:
  - SSL/TLS certificates
  - SSH private keys
  - Signing keys
  - Encryption keys

Tokens:
  - OAuth tokens
  - JWT signing secrets
  - Session secrets
  - CSRF tokens

Other:
  - Webhook secrets
  - MFA recovery codes
  - Backup encryption keys
```

**NOT Secrets (Can be in code):**
```yaml
Configuration:
  - API endpoints (public URLs)
  - Feature flags (non-sensitive)
  - UI text and labels
  - Public configuration

Identifiers:
  - User IDs
  - Organization IDs
  - Public API keys (explicitly public)
```

### 2. Never Commit Secrets

**Pre-commit Protection:**
```bash
# .git/hooks/pre-commit
#!/bin/bash

# Scan for common secret patterns
if git diff --cached | grep -E '(api_key|password|secret|token|private_key).*=.*[A-Za-z0-9]{20,}'; then
  echo "âŒ ERROR: Potential secret detected in commit!"
  echo "Please remove secrets and use environment variables instead."
  exit 1
fi

# Check for .env files
if git diff --cached --name-only | grep -E '\.env$'; then
  echo "âŒ ERROR: .env file should not be committed!"
  echo "Add .env to .gitignore"
  exit 1
fi

# Use git-secrets (if installed)
if command -v git-secrets &> /dev/null; then
  git secrets --scan
fi
```

**gitignore (Always Include):**
```gitignore
# Environment variables
.env
.env.local
.env.*.local
.env.production

# Credentials
credentials.json
serviceAccountKey.json
*.pem
*.key
*.pfx

# IDE
.vscode/settings.json (if contains secrets)
.idea/workspace.xml

# OS
.DS_Store
Thumbs.db

# Backups
*.backup
*.bak
```

**git-secrets Setup:**
```bash
# Install git-secrets
brew install git-secrets  # macOS
# or
apt-get install git-secrets  # Linux

# Initialize in repo
git secrets --install
git secrets --register-aws  # AWS patterns

# Add custom patterns
git secrets --add 'sk_live_[a-zA-Z0-9]{24}'  # Stripe secret key
git secrets --add 'sk-[a-zA-Z0-9]{48}'        # OpenAI key
git secrets --add 'ghp_[a-zA-Z0-9]{36}'       # GitHub token
```

### 3. Environment Variables (Development)

**Local Development (.env):**
```bash
# .env (NEVER commit this file!)

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/myapp_dev

# Authentication
NEXTAUTH_SECRET=dev_secret_change_in_production_minimum_32_chars
NEXTAUTH_URL=http://localhost:3000

# Third-party APIs
STRIPE_SECRET_KEY=sk_test_xxxxx  # Test key (safe for dev)
OPENAI_API_KEY=sk-xxxxx          # Personal dev key

# Feature Flags
FEATURE_NEW_UI=true
```

**.env.example (Safe to commit):**
```bash
# .env.example
# Copy this to .env and fill in real values

# Database
DATABASE_URL=postgresql://user:pass@localhost:5432/myapp_dev

# Authentication
NEXTAUTH_SECRET=generate_a_random_32_character_string
NEXTAUTH_URL=http://localhost:3000

# Third-party APIs (get from service dashboards)
STRIPE_SECRET_KEY=sk_test_your_test_key_here
OPENAI_API_KEY=sk-your_api_key_here

# Feature Flags
FEATURE_NEW_UI=true
```

**Loading Environment Variables:**
```typescript
// lib/env.ts
import { z } from 'zod';

// Validate environment variables at startup
const envSchema = z.object({
  // Database
  DATABASE_URL: z.string().url(),
  
  // Auth
  NEXTAUTH_SECRET: z.string().min(32),
  NEXTAUTH_URL: z.string().url(),
  
  // Third-party (optional in dev)
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  OPENAI_API_KEY: z.string().startsWith('sk-').optional(),
});

// Parse and validate
export const env = envSchema.parse(process.env);

// Type-safe environment variables
export type Env = z.infer<typeof envSchema>;
```

### 4. Secrets in Production (Vercel)

**Vercel Environment Variables:**
```bash
# Add secrets to Vercel (encrypted at rest)
vercel env add DATABASE_URL production
# Enter value (not echoed to terminal)

vercel env add NEXTAUTH_SECRET production
# Auto-generate: openssl rand -base64 32

vercel env add STRIPE_SECRET_KEY production
# Use production key from Stripe dashboard

# List environment variables (values hidden)
vercel env ls

# Pull production env vars (for debugging)
vercel env pull .env.production.local
# âš ï¸ Don't commit this file!
```

**Vercel Environment Variable Types:**
```yaml
Production:
  - Used in: Production deployments
  - Examples: Production API keys, prod database

Preview:
  - Used in: Preview deployments (PRs)
  - Examples: Test API keys, staging database

Development:
  - Used in: Local development (vercel dev)
  - Examples: Local database, test keys
```

**System Environment Variables (Automatic):**
```typescript
// Available in Vercel deployments
const systemEnv = {
  VERCEL: '1',                    // Indicates Vercel environment
  VERCEL_ENV: 'production',       // production|preview|development
  VERCEL_URL: 'app.example.com',  // Deployment URL
  VERCEL_REGION: 'iad1',          // Deployment region
  VERCEL_GIT_COMMIT_SHA: 'abc123',
  VERCEL_GIT_COMMIT_REF: 'main',
};
```

### 5. Secret Rotation

**Rotation Schedule:**
```yaml
Critical Secrets (Every 30 days):
  - Database passwords
  - Admin credentials
  - Production API keys with broad access
  - Signing keys

Important Secrets (Every 90 days):
  - Service API keys
  - OAuth secrets
  - Session secrets

Regular Rotation (Every 180 days):
  - Less critical API keys
  - Development/staging credentials
```

**Rotation Procedure:**
```markdown
## Secret Rotation Procedure

### 1. Generate New Secret
```bash
# For random secrets
openssl rand -base64 32

# For API keys
# Generate in service dashboard (Stripe, OpenAI, etc.)
```

### 2. Add New Secret (Parallel)
```bash
# Add with suffix first (both old and new work)
vercel env add STRIPE_SECRET_KEY_NEW production
```

### 3. Update Application Code (if needed)
```typescript
// Support both old and new keys during transition
const stripeKey = process.env.STRIPE_SECRET_KEY_NEW || 
                  process.env.STRIPE_SECRET_KEY;
```

### 4. Deploy with New Secret
```bash
vercel deploy --prod
```

### 5. Verify New Secret Works
- Monitor error rates
- Test critical functionality
- Check logs for auth failures

### 6. Remove Old Secret
```bash
# After 24-48 hours of new secret working
vercel env rm STRIPE_SECRET_KEY production
vercel env add STRIPE_SECRET_KEY production
# (enter NEW secret value)
```

### 7. Revoke Old Secret
- Revoke in service dashboard (Stripe, etc.)
- Document rotation in changelog
```

**Automated Rotation Reminders:**
```typescript
// scripts/check-secret-age.ts
import { z } from 'zod';

const secretAgeSchema = z.object({
  name: z.string(),
  created: z.date(),
  rotationPeriod: z.number(), // days
});

const secrets = [
  { name: 'DATABASE_URL', created: new Date('2024-01-01'), rotationPeriod: 90 },
  { name: 'NEXTAUTH_SECRET', created: new Date('2024-01-15'), rotationPeriod: 90 },
  { name: 'STRIPE_SECRET_KEY', created: new Date('2023-12-01'), rotationPeriod: 30 },
];

secrets.forEach(secret => {
  const age = (Date.now() - secret.created.getTime()) / (1000 * 60 * 60 * 24);
  const daysUntilRotation = secret.rotationPeriod - age;
  
  if (daysUntilRotation < 0) {
    console.error(`âŒ ${secret.name} is OVERDUE for rotation by ${Math.abs(daysUntilRotation).toFixed(0)} days!`);
  } else if (daysUntilRotation < 7) {
    console.warn(`âš ï¸ ${secret.name} needs rotation in ${daysUntilRotation.toFixed(0)} days`);
  } else {
    console.log(`âœ… ${secret.name} rotation in ${daysUntilRotation.toFixed(0)} days`);
  }
});
```

### 6. Secret Scanning

**Automated Secret Scanning:**
```yaml
# .github/workflows/secret-scan.yml
name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for scanning
      
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
```

**Manual Secret Scanning:**
```bash
# .cursor/tools/scan-secrets.sh
#!/bin/bash

echo "ðŸ” Scanning for secrets..."

# Check for common patterns
echo "Checking for API keys..."
git grep -i 'api[_-]key.*=.*[A-Za-z0-9]{20,}'

echo "Checking for passwords..."
git grep -i 'password.*=.*[^$][A-Za-z0-9]{8,}'

echo "Checking for tokens..."
git grep -i 'token.*=.*[A-Za-z0-9]{20,}'

echo "Checking for .env files..."
git ls-files | grep '\.env$'

# Check git history for leaked secrets
echo "Checking git history (last 100 commits)..."
git log -p -100 | grep -i -E '(api_key|password|secret|token).*=.*[A-Za-z0-9]{20,}'

echo "âœ… Secret scan complete"
```

### 7. Secret Access Control

**Principle of Least Privilege:**
```yaml
Access Levels:
  Production Secrets:
    - Who: Tech leads, on-call engineers only
    - Why: Minimize exposure of production credentials
    - How: Vercel team permissions
  
  Staging Secrets:
    - Who: All engineers
    - Why: Safe to access for debugging
    - How: Vercel team permissions
  
  Development Secrets:
    - Who: All engineers
    - Why: Local development
    - How: .env.example template
```

**Audit Logging:**
```typescript
// Log all secret access (production)
export async function getSecret(name: string, userId: string) {
  // Retrieve secret
  const secret = await secretManager.get(name);
  
  // Audit log
  await auditLog.create({
    action: 'SECRET_ACCESS',
    userId: userId,
    secretName: name,
    timestamp: new Date(),
    ipAddress: getClientIP(),
  });
  
  return secret;
}

// Review audit logs regularly
const recentAccess = await auditLog.findMany({
  where: {
    action: 'SECRET_ACCESS',
    timestamp: {
      gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // Last 7 days
    },
  },
  orderBy: { timestamp: 'desc' },
});
```

### 8. Emergency Secret Revocation

**If Secret is Compromised:**
```markdown
## Emergency Secret Revocation Procedure

â±ï¸ **Time is Critical - Act within 15 minutes**

### 1. Immediate Actions (< 5 min)

```bash
# 1.1 Revoke secret in service
# - Go to service dashboard (Stripe, GitHub, etc.)
# - Revoke/delete the compromised key IMMEDIATELY

# 1.2 Remove from Vercel
vercel env rm COMPROMISED_SECRET production

# 1.3 Generate new secret
NEW_SECRET=$(openssl rand -base64 32)

# 1.4 Add new secret
vercel env add COMPROMISED_SECRET production
# Enter: $NEW_SECRET
```

### 2. Deploy New Secret (< 5 min)

```bash
# Force deployment with new secret
vercel deploy --prod --force
```

### 3. Monitor (< 5 min)

- Check error rates (should be normal)
- Check for unauthorized access in service logs
- Verify application functionality

### 4. Post-Incident (< 30 min)

- [ ] Document what happened
- [ ] How was secret compromised?
- [ ] Update this runbook if needed
- [ ] Notify security team
- [ ] Review other secrets (any others compromised?)
- [ ] Implement preventive measures

### 5. Communication

**Internal:**
```markdown
#incidents

ðŸš¨ SECRET COMPROMISED - REVOKED

**Secret:** Stripe API Key
**Impact:** Potential unauthorized charges
**Action:** Revoked old key, deployed new key
**Status:** âœ… Resolved in 8 minutes
**Root Cause:** Accidentally committed to public repo
**Prevention:** Added git-secrets hook
```

**External (if needed):**
- Notify affected customers
- File security incident report
- Contact service provider (Stripe, etc.)
```

### 9. Secrets in CI/CD

**GitHub Actions Secrets:**
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel deploy --prod --token=$VERCEL_TOKEN
```

**Adding GitHub Secrets:**
```bash
# Repository Settings â†’ Secrets â†’ Actions â†’ New secret

# Or via GitHub CLI
gh secret set VERCEL_TOKEN --body "$(cat vercel-token.txt)"
```

### 10. Developer Onboarding

**New Developer Setup:**
```markdown
## Developer Secrets Setup

### 1. Get Access
- [ ] Added to GitHub team
- [ ] Added to Vercel team
- [ ] Added to 1Password vault (if used)

### 2. Local Development Secrets

```bash
# Clone repo
git clone git@github.com:org/repo.git
cd repo

# Copy environment template
cp .env.example .env

# Get development secrets from team
# Option A: Team provides .env file (secure transfer)
# Option B: Manual entry from .env.example

# Verify secrets work
npm run dev
# Should start without errors
```

### 3. Production Access (If Needed)

- [ ] Request production access from tech lead
- [ ] Justify need for access
- [ ] Get trained on secret handling
- [ ] Sign security policy

### 4. Tools Setup

```bash
# Install git-secrets
brew install git-secrets
git secrets --install
git secrets --register-aws

# Install secret scanner
npm install -g @trufflesecurity/trufflehog
```
```

## Secret Management Checklist

```markdown
## Security Checklist

### Prevention
- [ ] .gitignore includes .env files
- [ ] git-secrets pre-commit hook installed
- [ ] .env.example provided (no real secrets)
- [ ] All secrets use environment variables
- [ ] No hardcoded secrets in code

### Storage
- [ ] Production secrets in Vercel (encrypted)
- [ ] Development secrets in .env (gitignored)
- [ ] Sensitive docs in password manager
- [ ] Backup secrets encrypted

### Access
- [ ] Principle of least privilege applied
- [ ] Production access restricted
- [ ] Audit logging enabled
- [ ] Regular access reviews

### Rotation
- [ ] Rotation schedule defined
- [ ] Critical secrets rotated every 30 days
- [ ] Regular secrets rotated every 90 days
- [ ] Rotation procedure documented

### Monitoring
- [ ] Secret scanning in CI/CD
- [ ] Regular manual scans
- [ ] Compromised secret runbook
- [ ] Security incident response plan
```

## Common Mistakes to Avoid

```markdown
âŒ **DON'T:**
- Commit .env files to git
- Share secrets via email/Slack
- Use same secret across environments
- Hardcode secrets in code
- Log secrets in console/files
- Use weak secrets (< 32 characters)
- Leave default secrets in production
- Share production secrets unnecessarily

âœ… **DO:**
- Use environment variables
- Store secrets encrypted (Vercel, 1Password)
- Use different secrets per environment
- Rotate secrets regularly (30-90 days)
- Revoke compromised secrets immediately
- Use strong, random secrets (32+ chars)
- Audit secret access regularly
- Train team on secret handling
```

## See Also

### Documentation
- **`.cursor/docs/ai-workflows.md`** - Secret management workflows
- **`003-cursor-system-overview.mdc`** â­ - System overview

### Complete Guides
- **`guides/Security-Operations-Guide.md`** â­ - Complete security operations
- **`guides/Deployment-Complete-Guide.md`** â­ - Secrets in deployment

### Related Rules
- @011-env-var-security.mdc - Environment variable security, type safety, validation (use together with this rule)
- @012-api-security.mdc - API key security
- @220-security-monitoring.mdc - Security monitoring
- @221-application-monitoring.mdc - Monitor for leaked secrets

### Tools
- **`.cursor/tools/scan-secrets.sh`** â­ - Automated secret scanning
- **`.cursor/tools/check-env-vars.sh`** â­ - Validate environment setup

### Quick Start
1. **Never commit secrets:** Add .env to .gitignore, use git-secrets
2. **Use env vars:** All secrets via environment variables
3. **Rotate regularly:** 30-90 days depending on criticality
4. **Scan regularly:** CI/CD + manual secret scanning
5. **React fast:** Revoke compromised secrets < 15 minutes

## Priority
**P0 (Required)** - Secrets management is critical for security and preventing data breaches.

## References
- [OWASP Secrets Management](https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html)
- [Vercel Environment Variables](https://vercel.com/docs/concepts/projects/environment-variables)
- [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)
- [git-secrets](https://github.com/awslabs/git-secrets)
