---
description:
globs:
alwaysApply: false
---
___
description: Mandatory Auth0 configuration validation before any deployment to prevent authentication failures
globs: "**/*.{ts,tsx,js,jsx}"
___

# Auth0 Deployment Validation

## Context
- Authentication failures in production can break entire applications
- Auth0 SDK v4.6.0+ has specific configuration requirements
- Multiple Auth0 handlers cause undefined redirect errors
- URL construction failures are common in Edge Runtime

## Mandatory Pre-Deployment Validation

### Required Scripts in package.json
```json
{
  "scripts": {
    "predev": "npm run auth0:check",
    "prebuild": "npm run auth0:check", 
    "auth0:check": "node scripts/validate-auth0-config.js",
    "auth0:generate-secret": "node -e \"console.log('AUTH0_SECRET=' + require('crypto').randomBytes(16).toString('hex'))\""
  }
}
```

### Required Validation Checks

‚úÖ All environment variables present and correct format
‚úÖ AUTH0_SECRET exactly 32 characters
‚úÖ File structure follows v4.6.0+ requirements
‚úÖ No conflicting Auth0 handlers
‚úÖ Auth0 domain connectivity test
‚úÖ URL format validation with protocol checking

## Emergency Recovery Procedures
When Auth0 breaks in production:

1. Check Vercel function logs for specific errors
2. Run npm run auth0:check to identify configuration issues
3. Deploy emergency bypass middleware if needed
4. Fix root cause and redeploy

## Implementation Requirements

- Validation must run before every build and deployment
- Failing validation must stop deployment process
- Include detailed error messages with fix instructions
- Test discovery endpoint connectivity

## Example Validation Script

```javascript
// scripts/validate-auth0-config.js
const fs = require('fs');
const path = require('path');
const https = require('https');
const { execSync } = require('child_process');

// Colors for terminal output
const RED = '\x1b[31m';
const GREEN = '\x1b[32m';
const YELLOW = '\x1b[33m';
const RESET = '\x1b[0m';

// Required environment variables
const REQUIRED_ENV_VARS = [
  'AUTH0_SECRET',
  'AUTH0_BASE_URL',
  'AUTH0_ISSUER_BASE_URL',
  'AUTH0_CLIENT_ID',
  'AUTH0_CLIENT_SECRET',
  'AUTH0_DOMAIN'
];

// File structure validation
const REQUIRED_FILES = [
  { path: 'middleware.ts', error: 'middleware.ts must be in root directory' },
  { path: 'src/lib/auth0.ts', error: 'Auth0 client configuration missing' },
  { path: 'pages/auth/[...auth0].ts', error: 'Auth route handler missing' }
];

const FORBIDDEN_FILES = [
  { path: 'src/middleware.ts', error: 'middleware.ts should be in root, not src/' },
  { path: 'pages/api/auth/[...auth0].ts', error: 'Old v3.x path detected - remove this file' },
  { path: 'pages/auth/[...auth0].tsx', error: 'Duplicate handler detected - use .ts extension' }
];

// Validation functions
function validateEnvironmentVariables() {
  console.log('üîç Checking Auth0 environment variables...');
  
  const missingVars = [];
  
  for (const envVar of REQUIRED_ENV_VARS) {
    if (!process.env[envVar]) {
      missingVars.push(envVar);
    }
  }
  
  if (missingVars.length > 0) {
    console.error(`${RED}‚ùå Missing required environment variables: ${missingVars.join(', ')}${RESET}`);
    console.error(`${YELLOW}‚ÑπÔ∏è Make sure these are defined in your .env file or deployment environment${RESET}`);
    process.exit(1);
  }
  
  // Validate AUTH0_SECRET length
  if (process.env.AUTH0_SECRET && process.env.AUTH0_SECRET.length !== 32) {
    console.error(`${RED}‚ùå AUTH0_SECRET must be exactly 32 characters${RESET}`);
    console.error(`${YELLOW}‚ÑπÔ∏è Generate a new secret with: npm run auth0:generate-secret${RESET}`);
    process.exit(1);
  }
  
  console.log(`${GREEN}‚úÖ All required environment variables present${RESET}`);
  return true;
}

function validateFileStructure() {
  console.log('üîç Checking Auth0 file structure...');
  
  // Check required files
  const missingFiles = [];
  for (const file of REQUIRED_FILES) {
    if (!fs.existsSync(path.join(process.cwd(), file.path))) {
      missingFiles.push(`${file.path} - ${file.error}`);
    }
  }
  
  if (missingFiles.length > 0) {
    console.error(`${RED}‚ùå Missing required files:${RESET}`);
    missingFiles.forEach(file => console.error(`${RED}  - ${file}${RESET}`));
    process.exit(1);
  }
  
  // Check forbidden files
  const forbiddenFilesFound = [];
  for (const file of FORBIDDEN_FILES) {
    if (fs.existsSync(path.join(process.cwd(), file.path))) {
      forbiddenFilesFound.push(`${file.path} - ${file.error}`);
    }
  }
  
  if (forbiddenFilesFound.length > 0) {
    console.error(`${RED}‚ùå Forbidden files detected:${RESET}`);
    forbiddenFilesFound.forEach(file => console.error(`${RED}  - ${file}${RESET}`));
    process.exit(1);
  }
  
  console.log(`${GREEN}‚úÖ File structure is correct${RESET}`);
  return true;
}

function validateAuth0Connectivity() {
  console.log('üîç Testing Auth0 domain connectivity...');
  
  const domain = process.env.AUTH0_DOMAIN || 
                 process.env.AUTH0_ISSUER_BASE_URL?.replace('https://', '').split('/')[0];
                 
  if (!domain) {
    console.error(`${RED}‚ùå Cannot determine Auth0 domain from environment variables${RESET}`);
    process.exit(1);
  }
  
  return new Promise((resolve, reject) => {
    const discoveryUrl = `https://${domain}/.well-known/openid-configuration`;
    
    https.get(discoveryUrl, (res) => {
      if (res.statusCode === 200) {
        console.log(`${GREEN}‚úÖ Successfully connected to Auth0 discovery endpoint${RESET}`);
        resolve(true);
      } else {
        console.error(`${RED}‚ùå Failed to connect to Auth0 discovery endpoint (Status: ${res.statusCode})${RESET}`);
        console.error(`${YELLOW}‚ÑπÔ∏è Check your Auth0 domain and make sure it's accessible${RESET}`);
        reject(new Error(`Auth0 connectivity check failed with status ${res.statusCode}`));
      }
    }).on('error', (err) => {
      console.error(`${RED}‚ùå Failed to connect to Auth0: ${err.message}${RESET}`);
      console.error(`${YELLOW}‚ÑπÔ∏è Check your network connectivity and Auth0 domain${RESET}`);
      reject(err);
    });
  });
}

function validateUrlFormats() {
  console.log('üîç Validating URL formats...');
  
  const urlVars = ['AUTH0_BASE_URL', 'AUTH0_ISSUER_BASE_URL'];
  const invalidUrls = [];
  
  for (const urlVar of urlVars) {
    const url = process.env[urlVar];
    if (url && !url.startsWith('http')) {
      invalidUrls.push(`${urlVar} (${url}) - must start with http:// or https://`);
    }
  }
  
  if (invalidUrls.length > 0) {
    console.error(`${RED}‚ùå Invalid URL formats detected:${RESET}`);
    invalidUrls.forEach(url => console.error(`${RED}  - ${url}${RESET}`));
    process.exit(1);
  }
  
  console.log(`${GREEN}‚úÖ All URL formats are valid${RESET}`);
  return true;
}

// Run all validations
async function runAllValidations() {
  console.log('üöÄ Starting Auth0 configuration validation...');
  
  try {
    validateEnvironmentVariables();
    validateFileStructure();
    validateUrlFormats();
    await validateAuth0Connectivity();
    
    console.log(`${GREEN}‚úÖ All Auth0 validations passed successfully!${RESET}`);
  } catch (error) {
    console.error(`${RED}‚ùå Auth0 validation failed: ${error.message}${RESET}`);
    process.exit(1);
  }
}

runAllValidations();
```

## Emergency Bypass Middleware

```typescript
// Emergency bypass middleware - deploy when Auth0 is broken
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export async function middleware(request: NextRequest) {
  // Emergency bypass - no Auth0 dependency
  console.warn('‚ö†Ô∏è Using emergency bypass middleware - Auth0 integration disabled');
  return NextResponse.next();
}

export const config = {
  matcher: [
    '/((?!_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)',
  ],
};
```

## Relationship with Other Rules
- Complements [019-auth0-integration.mdc](mdc:019-auth0-integration.mdc) for Auth0 implementation standards
- Supports [011-env-var-security.mdc](mdc:011-env-var-security.mdc) for secure environment variable handling
- Works with [200-deployment-infrastructure.mdc](mdc:200-deployment-infrastructure.mdc) for secure deployments

## See Also

### Documentation
- **`.cursor/docs/security-workflows.md#auth0-integration-workflow`** - Complete Auth0 setup guide
- **`.cursor/docs/security-checklist.md#authentication-authorization`** - Pre-deployment checks
- **`.cursor/rules/003-cursor-system-overview.mdc`** - System overview (READ THIS FIRST)

### Tools (USE THESE!)
- **`.cursor/tools/check-auth-config.sh`** - Validate Auth0 configuration
  ```bash
  ./.cursor/tools/check-auth-config.sh
  # Validates: Env vars, secret strength, secure cookies, SDK version
  ```
- **`.cursor/tools/check-env-vars.sh`** - Ensure no secrets exposed
- **`.cursor/tools/scan-secrets.sh`** - Detect hardcoded secrets

### Related Rules
- @002-rule-application.mdc - Source of Truth Hierarchy
- @014-third-party-auth.mdc - Authentication implementation standards
- @019-auth0-integration.mdc - Auth0 integration patterns (primary)
- @046-session-validation.mdc - Session security
- @047-session-token-debugging.mdc - Session debugging patterns
- @330-auth0-testing-standards.mdc - Auth0 testing standards
- @374-authentication-architecture-standards.mdc - Auth architecture
- @400-auth-testing-patterns.mdc - Auth testing patterns
- @410-auth-debugging.mdc - Auth debugging workflows

### Quick Start
1. **Validate:** `.cursor/tools/check-auth-config.sh`
2. **Follow:** `.cursor/docs/security-workflows.md#auth0-integration-workflow`
3. **Deploy:** `.cursor/docs/security-checklist.md#authentication-authorization`

### Comprehensive Guides
- **`guides/auth0/00-Auth0-Guide-Index.md`** ‚≠ê **Master Index** - Complete Auth0 guide system
- **`guides/AUTH0_CURRENT_IMPLEMENTATION.md`** - Current Auth0 setup and configuration
- **`guides/AUTH0_TROUBLESHOOTING_GUIDE.md`** - Common Auth0 issues and solutions
- **`guides/auth0/02-Environment-Specific-Guides.md`** - Dev/Staging/Prod configurations
- **`guides/auth0/06-Auth0-Implementation-Checklist.md`** - Deployment checklist
